# üöÄ Onboarding Simplificado - Resumen Ejecutivo

> **Flujo optimizado de 5 pasos para configurar una tienda en menos de 10 minutos**

## üéØ Objetivo

Crear un proceso de onboarding **dividido en dos fases**:

1. **üöÄ Onboarding Inicial** (3-5 min): Registro m√≠nimo para generar engagement
2. **‚öôÔ∏è Configuraci√≥n Completa** (Backoffice): Setup detallado paso a paso

**Filosof√≠a**: Conseguir el registro r√°pido, luego guiar la configuraci√≥n completa con gamificaci√≥n.

## üìä M√©tricas Objetivo

- ‚è±Ô∏è **Tiempo total**: < 10 minutos
- üìà **Tasa de completaci√≥n**: > 85%
- üéØ **Abandono por paso**: < 15%
- ‚úÖ **Time-to-first-product**: < 30 minutos

## üîÑ FASE 1: Onboarding Inicial (Landing ‚Üí Registro)

> **Objetivo**: Conseguir que se registre en 3-5 minutos m√°ximo

### Paso 1: üè† Bienvenida
**Pantalla**: Landing de bienvenida
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           üéâ Bienvenido a tu        ‚îÇ
‚îÇ             nueva tienda            ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  Comienza a configurar tu tienda    ‚îÇ
‚îÇ     en unos simples pasos.          ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ         [ Comenzar ]                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Objetivo**: Generar expectativa positiva y dar contexto del proceso.

---

### Paso 2: üë§ Datos de Usuario
**Pantalla**: Registro b√°sico del administrador

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    Paso 2 de 5    ‚óè‚óè‚óã‚óã‚óã             ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ         Nombre                      ‚îÇ
‚îÇ    [________________]               ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ      Correo electr√≥nico             ‚îÇ
‚îÇ    [________________]               ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ    Debe contener al menos 8 caracteres‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ     Confirmar contrase√±a            ‚îÇ
‚îÇ    [‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢]                ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ     Confirmar contrase√±a            ‚îÇ
‚îÇ    [‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢]                ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ         [ Siguiente ]               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Campos**:
- Nombre completo
- Correo electr√≥nico
- Contrase√±a (con validaci√≥n visual)
- Confirmar contrase√±a

**Validaciones**:
- Email v√°lido
- Contrase√±a m√≠nimo 8 caracteres
- Confirmaci√≥n coincidente

---

### Paso 3: ‚úâÔ∏è Verificaci√≥n de Email
**Pantalla**: Verificaci√≥n por c√≥digo

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    Paso 3 de 5    ‚óè‚óè‚óè‚óã‚óã             ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ         üìß Verify Your Email        ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ   Please enter the 6-digit          ‚îÇ
‚îÇ   verification code that was        ‚îÇ
‚îÇ   sent to:                          ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ     example@example.com             ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ     Verification Code               ‚îÇ
‚îÇ    [____][____][____]               ‚îÇ
‚îÇ    [____][____][____]               ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ         [ Continue ]                ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ      Don't receive the code?        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Funcionalidad**:
- C√≥digo de 6 d√≠gitos enviado por email
- Opci√≥n "reenviar c√≥digo" 
- Validaci√≥n autom√°tica al completar

---

### Paso 4: üè™ Configuraci√≥n Inicial del Cat√°logo
**Pantalla**: Configuraci√≥n b√°sica del negocio y selecci√≥n de categor√≠as

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    Paso 4 de 5    ‚óè‚óè‚óè‚óè‚óã             ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ      Configuraci√≥n de tu Tienda     ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ     Nombre de la tienda             ‚îÇ
‚îÇ    [________________]               ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ     Seleccionar rubro               ‚îÇ
‚îÇ    [ Hogar y Construcci√≥n  ‚ñº ]      ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ           Tama√±o                    ‚îÇ
‚îÇ   üè™        üè¢        üè¨           ‚îÇ
‚îÇ  Micro      PYME     Varias         ‚îÇ
‚îÇ emprendimiento     Sucursales       ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ    Categor√≠as principales (min 1)   ‚îÇ
‚îÇ   ‚òë Pinturas      ‚òë Herramientas   ‚îÇ
‚îÇ   ‚òê Cerrajer√≠a    ‚òë Electricidad   ‚îÇ
‚îÇ   ‚òê Plomer√≠a      ‚òê Jardiner√≠a     ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ         [ Siguiente ]               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Campos**:
- **Nombre de la tienda**: Texto libre
- **Rubro**: Dropdown sincronizado con PIM Service
- **Tama√±o**: Selector visual con 3 opciones
- **Categor√≠as principales**: Checkbox m√∫ltiple (m√≠nimo 1, din√°mico seg√∫n rubro)

**Rubros disponibles** (sincronizados con PIM Service):

| Onboarding UI | PIM business_type | Nombre PIM |
|---------------|------------------|------------|
| Pinturer√≠a | `home-construction` | Hogar y Construcci√≥n |
| Ferreter√≠a | `home-construction` | Hogar y Construcci√≥n |
| Ropa y accesorios | `fashion` | Moda y Vestimenta |
| Electr√≥nicos | `electronics` | Electr√≥nicos y Tecnolog√≠a |
| Repuestos automotriz | `automotive` | Automotriz y Repuestos |
| Libros y papeler√≠a | `books-media` | Libros y Medios |
| Alimentos y bebidas | `food-beverage` | Alimentos y Bebidas |
| Salud y farmacia | `health-pharmacy` | Salud y Farmacia |
| Deportes | `sports-fitness` | Deportes y Fitness |
| Belleza | `beauty-cosmetics` | Belleza y Cosm√©ticos |
| Juguetes | `toys-games` | Juguetes y Juegos |
| Mascotas | `pet-supplies` | Mascotas y Suministros |
| Oficina | `office-supplies` | Oficina y Papeler√≠a |
| Joyer√≠a | `jewelry-accessories` | Joyer√≠a y Accesorios |
| Polirubro | `polirubro` | Polirubro |

> **Nota**: Los business types se obtienen din√°micamente desde PIM Service para garantizar sincronizaci√≥n.

---

### Paso 5: üéâ Bienvenida al Backoffice
**Pantalla**: Redirigir al dashboard con onboarding pendiente

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         üéâ ¬°Bienvenido!             ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ    ¬°Tu cuenta est√° creada!          ‚îÇ
‚îÇ     Ahora configuremos tu tienda    ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ     [ Ir al Panel de Control ]     ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ   üí° Tip: Configura tu tienda en    ‚îÇ
‚îÇ      menos de 10 minutos            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Acci√≥n**: Redirigir a `/backoffice/onboarding-setup`

---

## üöÄ Pr√≥ximos Pasos

Una vez completado el onboarding inicial de 5 pasos, el usuario ser√° redirigido al **backoffice** donde podr√° completar la configuraci√≥n avanzada de su tienda con funcionalidades como:

- üìù Informaci√≥n de la empresa
- üè¢ Perfil operativo  
- üìç Configuraci√≥n de ubicaciones
- üé® Personalizaci√≥n de marca
- üì¶ Cat√°logo inicial

> **Nota**: La configuraci√≥n completa del backoffice se dise√±ar√° e implementar√° en una fase posterior.


## üóÑÔ∏è Base de Datos

### Tabla: `onboarding_step_definitions` (Master data - Definici√≥n de pasos)
```sql
CREATE TABLE onboarding_step_definitions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    step_number INT NOT NULL UNIQUE, -- 1, 2, 3, 4, 5
    step_name VARCHAR(255) NOT NULL, -- 'bienvenida', 'registro', 'verificacion', etc.
    step_title VARCHAR(255) NOT NULL, -- 'Bienvenida', 'Datos de Usuario', etc.
    description TEXT,
    is_required BOOLEAN DEFAULT TRUE,
    
    -- Configuraci√≥n del paso
    has_ui BOOLEAN DEFAULT TRUE, -- false para pasos autom√°ticos
    requires_user_input BOOLEAN DEFAULT TRUE,
    can_be_skipped BOOLEAN DEFAULT FALSE,
    
    -- Orden y agrupaci√≥n
    display_order INT NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

### Tabla: `onboarding_processes`
```sql
CREATE TABLE onboarding_processes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL,
    user_id UUID NOT NULL,
    
    -- Estado del proceso
    current_step_number INT DEFAULT 1,
    is_completed BOOLEAN DEFAULT FALSE,
    
    -- Datos capturados durante el onboarding
    company_name VARCHAR(255),
    business_type VARCHAR(100), -- 'pintureria', 'ferreteria', etc.
    store_size VARCHAR(50), -- 'micro', 'pyme', 'multiple'
    
    -- Control de progreso
    steps_completed JSONB DEFAULT '[]', -- [1, 2, 3]
    steps_pending JSONB DEFAULT '[1,2,3,4,5]', -- [4, 5]
    steps_skipped JSONB DEFAULT '[]', -- []
    
    -- Timing
    started_at TIMESTAMP DEFAULT NOW(),
    completed_at TIMESTAMP NULL,
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

### Tabla: `onboarding_step_progress` (Progreso individual de cada paso)
```sql
CREATE TABLE onboarding_step_progress (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    process_id UUID NOT NULL REFERENCES onboarding_processes(id),
    step_definition_id UUID NOT NULL REFERENCES onboarding_step_definitions(id),
    
    -- Estado del paso
    status VARCHAR(50) DEFAULT 'pending', -- 'pending', 'in_progress', 'completed', 'skipped', 'failed'
    
    -- Datos espec√≠ficos del paso
    step_data JSONB, -- datos variables seg√∫n el paso
    
    -- Timing individual
    started_at TIMESTAMP NULL,
    completed_at TIMESTAMP NULL,
    time_spent_seconds INT NULL,
    
    -- Errores/intentos
    attempts_count INT DEFAULT 0,
    last_error TEXT NULL,
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(process_id, step_definition_id)
);
```

### üìã Datos Iniciales (Seed Data)

#### Steps Definition:
```sql
INSERT INTO onboarding_step_definitions (step_number, step_name, step_title, description, has_ui, requires_user_input, display_order) VALUES
(1, 'bienvenida', 'Bienvenida', 'Pantalla de bienvenida al onboarding', true, false, 1),
(2, 'registro', 'Datos de Usuario', 'Captura nombre, email y contrase√±a', true, true, 2),
(3, 'verificacion', 'Verificar Email', 'Validaci√≥n del c√≥digo de verificaci√≥n', true, true, 3),
(4, 'configuracion_tienda', 'Detalles de la Tienda', 'Configuraci√≥n b√°sica del negocio', true, true, 4),
(5, 'completar', 'Finalizar', 'Completar onboarding y redirecci√≥n', true, false, 5);
```

### üîó Business Types desde PIM Service

> **Nota**: Los `business_types` NO se almacenan localmente. Se obtienen din√°micamente desde el **PIM Service** que ya tiene toda la configuraci√≥n.

#### Endpoint PIM Service:
```bash
GET /api/v1/quickstart/business-types
```

#### Respuesta esperada:
```json
{
  "business_types": [
    {
      "id": "retail",
      "name": "Comercio Minorista", 
      "description": "Tiendas de venta al por menor",
      "icon": "store"
    },
    {
      "id": "pintureria",
      "name": "Pinturer√≠a",
      "description": "Venta de pinturas y accesorios", 
      "icon": "üé®"
    },
    {
      "id": "ferreteria", 
      "name": "Ferreter√≠a",
      "description": "Herramientas y materiales de construcci√≥n",
      "icon": "üîß"
    }
  ]
}
```

#### En el paso 4 del onboarding:
```go
// SetupStoreUseCase obtiene los business types del PIM Service y aplica configuraci√≥n
func (uc *SetupStoreUseCase) Execute(req SetupStoreRequest) (*SetupStoreResponse, error) {
    // 1. Obtener tipos de negocio disponibles
    businessTypes, err := uc.pimClient.GetBusinessTypes()
    if err != nil {
        return nil, err
    }
    
    // 2. Actualizar datos en el proceso de onboarding
    process := uc.onboardingRepo.GetByID(req.ProcessID)
    process.CompanyName = req.StoreName
    process.BusinessType = req.BusinessType
    process.StoreSize = req.StoreSize
    
    // 3. Recomendar plan basado en store_size
    recommendedPlan := uc.determinePlanBySize(req.StoreSize)
    
    // 4. Guardar configuraci√≥n para usar despu√©s en el backoffice
    uc.onboardingRepo.Save(process)
    
    return &SetupStoreResponse{
        StoreConfigured: true,
        BusinessTypeApplied: req.BusinessType,
        StoreSizeApplied: req.StoreSize,
        PlanRecommended: recommendedPlan,
        NextStep: 5,
    }, nil
}

func (uc *SetupStoreUseCase) determinePlanBySize(storeSize string) string {
    switch storeSize {
    case "micro":
        return "basic"
    case "pyme": 
        return "professional"
    case "multiple":
        return "enterprise"
    default:
        return "basic"
    }
}
```

#### En el backoffice (FUTURO):
```go
// Cuando el usuario llegue al backoffice, se aplicar√° la configuraci√≥n completa
func (uc *ApplyOnboardingConfigUseCase) Execute(tenantID string) error {
    // 1. Obtener datos del onboarding
    process := uc.onboardingRepo.GetByTenantID(tenantID)
    
    // 2. Asignar plan recomendado al tenant (IAM Service)
    err := uc.iamClient.SetTenantPlan(tenantID, process.RecommendedPlan)
    
    // 3. Aplicar quickstart template (PIM Service)
    templateConfig := QuickstartConfig{
        BusinessType: process.BusinessType,
        StoreSize: process.StoreSize, // Determina l√≠mites y funcionalidades
    }
    err = uc.pimClient.ApplyQuickstartTemplate(tenantID, templateConfig)
    
    return nil
}
```

---

### üîÑ Implementaci√≥n de los Flujos Mejorados

#### 1. üë§ Flujo de Registro de Usuario (Paso 2)
```go
// RegisterUserUseCase - Flujo completo con creaci√≥n de tenant y usuario TENANT_ADMIN
func (uc *RegisterUserUseCase) Execute(req RegisterUserRequest) (*RegisterUserResponse, error) {
    // 1. üè¢ Crear tenant temporal
    tenantData := &CreateTenantRequest{
        Name:        fmt.Sprintf("Tienda de %s", req.Name),
        Slug:        generateSlugFromName(req.Name),
        Description: fmt.Sprintf("Tienda administrada por %s", req.Email),
        Type:        "STARTUP", // Default temporal, se actualiza en paso 4
        OwnerID:     "temp-uuid", // Se actualiza despu√©s
    }
    
    tenant, err := uc.iamClient.CreateTenant(tenantData)
    if err != nil {
        return nil, fmt.Errorf("error creating tenant: %w", err)
    }
    
    // 2. üë§ Obtener rol TENANT_ADMIN
    tenantAdminRole, err := uc.iamClient.GetRoleByType("TENANT_ADMIN")
    if err != nil {
        return nil, fmt.Errorf("error getting tenant admin role: %w", err)
    }
    
    // 3. üßë‚Äçüíº Crear usuario con rol de administrador
    userData := &CreateUserRequest{
        Email:    req.Email,
        Password: req.Password,
        TenantID: tenant.ID,
        RoleID:   tenantAdminRole.ID,
        Provider: "LOCAL",
    }
    
    user, err := uc.iamClient.CreateUser(userData)
    if err != nil {
        // Rollback: eliminar tenant si falla creaci√≥n de usuario
        uc.iamClient.DeleteTenant(tenant.ID)
        return nil, fmt.Errorf("error creating user: %w", err)
    }
    
    // 4. üîÑ Actualizar owner del tenant
    err = uc.iamClient.UpdateTenantOwner(tenant.ID, user.ID)
    if err != nil {
        return nil, fmt.Errorf("error updating tenant owner: %w", err)
    }
    
    // 5. üìß Enviar c√≥digo de verificaci√≥n
    err = uc.notificationClient.SendVerificationCode(user.Email)
    if err != nil {
        return nil, fmt.Errorf("error sending verification code: %w", err)
    }
    
    // 6. üíæ Actualizar proceso de onboarding
    process, err := uc.onboardingRepo.GetByID(req.ProcessID)
    if err != nil {
        return nil, err
    }
    
    process.TenantID = tenant.ID
    process.UserID = user.ID
    process.CurrentStepNumber = 3
    process.StepsCompleted = append(process.StepsCompleted, 1, 2)
    process.StepsPending = []int{3, 4, 5}
    
    err = uc.onboardingRepo.Save(process)
    if err != nil {
        return nil, err
    }
    
    return &RegisterUserResponse{
        ProcessID:         req.ProcessID,
        UserID:           user.ID,
        TenantID:         tenant.ID,
        TenantSlug:       tenant.Slug,
        RoleAssigned:     "TENANT_ADMIN",
        TenantType:       tenant.Type,
        CanAccessBackoffice: true,
        VerificationCodeSent: true,
        CurrentStep:      3,
        StepsCompleted:   []int{1, 2},
        StepsPending:     []int{3, 4, 5},
        NextStepURL:      "/onboarding/verificar-email",
    }, nil
}

// Funci√≥n auxiliar para generar slug √∫nico
func generateSlugFromName(name string) string {
    // Convertir a lowercase y reemplazar espacios por guiones
    slug := strings.ToLower(strings.ReplaceAll(name, " ", "-"))
    // Agregar timestamp para unicidad
    timestamp := time.Now().Format("20060102")
    return fmt.Sprintf("%s-%s", slug, timestamp)
}
```

#### 2. üè™ Flujo de Configuraci√≥n de Tienda (Paso 4)
```go
// SetupStoreUseCase - Actualizaci√≥n completa del tenant con datos finales
func (uc *SetupStoreUseCase) Execute(req SetupStoreRequest) (*SetupStoreResponse, error) {
    // 1. üìã Obtener proceso actual
    process, err := uc.onboardingRepo.GetByID(req.ProcessID)
    if err != nil {
        return nil, err
    }
    
    // 2. üè¢ Actualizar tenant con datos finales
    tenantUpdateData := &UpdateTenantRequest{
        Name:        req.StoreName,
        Slug:        generateSlugFromStoreName(req.StoreName),
        Description: fmt.Sprintf("Tienda de %s especializada en %s", req.StoreName, req.BusinessType),
        Type:        mapStoreTypeToTenantType(req.StoreSize),
    }
    
    tenant, err := uc.iamClient.UpdateTenant(process.TenantID, tenantUpdateData)
    if err != nil {
        return nil, fmt.Errorf("error updating tenant: %w", err)
    }
    
    // 3. üéØ Aplicar configuraci√≥n PIM con quickstart template
    pimSetupData := &PIMSetupRequest{
        BusinessType:       req.BusinessType,
        SelectedCategories: req.SelectedCategories,
        SelectedAttributes: []string{}, // Usar por defecto del business_type
        SelectedVariants:   []string{}, // Usar por defecto del business_type
        SelectedProducts:   []string{}, // Incluir productos ejemplo seg√∫n req.IncludeSampleProducts
    }
    
    if req.IncludeSampleProducts {
        // Obtener productos ejemplo por defecto del business_type
        sampleProducts, err := uc.pimClient.GetSampleProductsByBusinessType(req.BusinessType)
        if err == nil {
            pimSetupData.SelectedProducts = sampleProducts
        }
    }
    
    pimHistory, err := uc.pimClient.SetupTenant(process.TenantID, pimSetupData)
    if err != nil {
        return nil, fmt.Errorf("error setting up PIM configuration: %w", err)
    }
    
    // 4. üìä Determinar plan recomendado
    recommendedPlan := uc.determinePlanBySize(req.StoreSize)
    
    // 5. üíæ Actualizar proceso con datos de tienda y configuraci√≥n PIM
    process.CompanyName = req.StoreName
    process.BusinessType = req.BusinessType
    process.StoreSize = req.StoreSize
    process.PIMConfigured = true
    process.CatalogSetupCompleted = true
    process.CurrentStepNumber = 5
    process.StepsCompleted = append(process.StepsCompleted, 4)
    process.StepsPending = []int{5}
    
    err = uc.onboardingRepo.Save(process)
    if err != nil {
        return nil, err
    }
    
    return &SetupStoreResponse{
        ProcessID:              req.ProcessID,
        StoreConfigured:        true,
        BusinessTypeApplied:    req.BusinessType,
        StoreSizeApplied:       req.StoreSize,
        PlanRecommended:        recommendedPlan,
        TenantUpdated:          true,
        TenantName:             tenant.Name,
        TenantSlug:             tenant.Slug,
        TenantType:             tenant.Type,
        CatalogConfigured:      true,
        CategoriesCreated:      req.SelectedCategories,
        AttributesCreated:      len(pimHistory.AttributesCreated),
        SampleProductsCreated:  len(pimHistory.ProductsCreated),
        PIMSetupCompleted:      true,
        CurrentStep:            5,
        StepsCompleted:         process.StepsCompleted,
        StepsPending:           []int{5},
        NextStepURL:            "/onboarding/completar",
    }, nil
}

// Mapeo de store_size a tenant_type
func mapStoreTypeToTenantType(storeSize string) string {
    switch storeSize {
    case "micro":
        return "STARTUP"
    case "pyme":
        return "BUSINESS"
    case "multiple":
        return "ENTERPRISE"
    default:
        return "STARTUP"
    }
}

// Mapeo de store_size a plan recomendado
func (uc *SetupStoreUseCase) determinePlanBySize(storeSize string) string {
    switch storeSize {
    case "micro":
        return "basic"
    case "pyme":
        return "professional"
    case "multiple":
        return "enterprise"
    default:
        return "basic"
    }
}
```

#### 3. üéâ Flujo de Completaci√≥n (Paso 5)
```go
// CompleteOnboardingUseCase - Validaci√≥n final y preparaci√≥n para backoffice
func (uc *CompleteOnboardingUseCase) Execute(req CompleteOnboardingRequest) (*CompleteOnboardingResponse, error) {
    // 1. üìã Obtener y validar proceso
    process, err := uc.onboardingRepo.GetByID(req.ProcessID)
    if err != nil {
        return nil, err
    }
    
    if len(process.StepsCompleted) < 4 {
        return nil, fmt.Errorf("onboarding incompleto: solo %d pasos completados", len(process.StepsCompleted))
    }
    
    // 2. ‚úÖ Validar que el usuario tenga permisos correctos
    user, err := uc.iamClient.GetUserByID(process.UserID)
    if err != nil {
        return nil, fmt.Errorf("error validating user: %w", err)
    }
    
    // Verificar que tiene rol TENANT_ADMIN
    role, err := uc.iamClient.GetRoleByID(user.RoleID)
    if err != nil || role.Type != "TENANT_ADMIN" {
        return nil, fmt.Errorf("user does not have TENANT_ADMIN role")
    }
    
    // 3. üîê Generar token de acceso para backoffice
    loginData := &LoginRequest{
        Email:    user.Email,
        TenantID: process.TenantID,
    }
    
    authResponse, err := uc.iamClient.GenerateAccessToken(loginData)
    if err != nil {
        return nil, fmt.Errorf("error generating access token: %w", err)
    }
    
    // 4. üè¢ Obtener resumen del tenant
    tenant, err := uc.iamClient.GetTenantByID(process.TenantID)
    if err != nil {
        return nil, fmt.Errorf("error getting tenant summary: %w", err)
    }
    
    // 5. üíæ Marcar proceso como completado
    process.IsCompleted = true
    process.CompletedAt = time.Now()
    process.CurrentStepNumber = 5
    process.StepsCompleted = []int{1, 2, 3, 4, 5}
    process.StepsPending = []int{}
    
    err = uc.onboardingRepo.Save(process)
    if err != nil {
        return nil, err
    }
    
    // 6. üìß Notificar configuraci√≥n lista (opcional)
    uc.notificationClient.SendOnboardingCompleted(user.Email, tenant.Name)
    
    return &CompleteOnboardingResponse{
        ProcessID:               req.ProcessID,
        OnboardingCompleted:     true,
        UserReadyForBackoffice:  true,
        TenantAdminConfirmed:    true,
        AccessToken:            authResponse.AccessToken,
        BackofficeURL:          fmt.Sprintf("/backoffice/dashboard?first_time=true&process_id=%s", req.ProcessID),
        RedirectURL:            fmt.Sprintf("https://app.example.com/backoffice/dashboard?first_time=true&process_id=%s", req.ProcessID),
        TenantSummary: TenantSummary{
            TenantID:         tenant.ID,
            TenantName:       tenant.Name,
            TenantSlug:       tenant.Slug,
            BusinessType:     process.BusinessType,
            StoreSize:        process.StoreSize,
            PlanRecommended:  uc.determinePlanBySize(process.StoreSize),
            OwnerConfirmed:   true,
        },
        StepsCompleted:   []int{1, 2, 3, 4, 5},
        StepsPending:     []int{},
        TotalTimeMinutes: float64(time.Since(process.StartedAt).Seconds()) / 60.0,
    }, nil
}
```

#### 4. üìä Iniciar un nuevo proceso de onboarding:
```go
// Al crear un nuevo proceso
process := &OnboardingProcess{
    TenantID: "", // Se asigna en paso 2
    UserID: "", // Se asigna en paso 2
    CurrentStepNumber: 1,
    StepsCompleted: []int{}, // vac√≠o
    StepsPending: []int{1, 2, 3, 4, 5}, // todos pendientes
    StepsSkipped: []int{}, // vac√≠o
}

// Tambi√©n crear registros de progreso para cada paso
for _, stepDef := range stepDefinitions {
    stepProgress := &OnboardingStepProgress{
        ProcessID: process.ID,
        StepDefinitionID: stepDef.ID,
        Status: "pending",
    }
}
```

#### 2. Completar un paso:
```go
// Cuando el usuario completa el paso 2 (registro)
func CompleteStep(processID string, stepNumber int, stepData map[string]interface{}) error {
    // 1. Actualizar el progreso individual del paso
    stepProgress.Status = "completed"
    stepProgress.CompletedAt = time.Now()
    stepProgress.StepData = stepData
    
    // 2. Actualizar el proceso general
    process.StepsCompleted = append(process.StepsCompleted, stepNumber)
    process.StepsPending = removeFromSlice(process.StepsPending, stepNumber)
    process.CurrentStepNumber = getNextPendingStep(process.StepsPending)
    
    return nil
}
```

#### 3. Obtener estado actual:
```go
type OnboardingStatus struct {
    ProcessID       string                    `json:"process_id"`
    CurrentStep     int                      `json:"current_step"`
    StepsCompleted  []int                    `json:"steps_completed"`
    StepsPending    []int                    `json:"steps_pending"`
    StepsSkipped    []int                    `json:"steps_skipped"`
    ProgressPercent float64                  `json:"progress_percent"`
    StepDetails     []OnboardingStepDetail   `json:"step_details"`
}

type OnboardingStepDetail struct {
    StepNumber      int       `json:"step_number"`
    StepName        string    `json:"step_name"`
    StepTitle       string    `json:"step_title"`
    Status          string    `json:"status"`
    IsRequired      bool      `json:"is_required"`
    CanBeSkipped    bool      `json:"can_be_skipped"`
    CompletedAt     *time.Time `json:"completed_at,omitempty"`
    TimeSpent       *int      `json:"time_spent_seconds,omitempty"`
}
```

#### 4. Ejemplo de respuesta del endpoint `/status`:
```json
{
  "process_id": "uuid-process-123",
  "current_step": 3,
  "steps_completed": [1, 2],
  "steps_pending": [3, 4, 5],
  "steps_skipped": [],
  "progress_percent": 40.0,
  "step_details": [
    {
      "step_number": 1,
      "step_name": "bienvenida",
      "step_title": "Bienvenida",
      "status": "completed",
      "is_required": true,
      "can_be_skipped": false,
      "completed_at": "2024-01-15T10:30:00Z",
      "time_spent_seconds": 45
    },
    {
      "step_number": 2,
      "step_name": "registro",
      "step_title": "Datos de Usuario",
      "status": "completed",
      "is_required": true,
      "can_be_skipped": false,
      "completed_at": "2024-01-15T10:32:30Z",
      "time_spent_seconds": 120
    },
    {
      "step_number": 3,
      "step_name": "verificacion",
      "step_title": "Verificar Email",
      "status": "in_progress",
      "is_required": true,
      "can_be_skipped": false
    },
    {
      "step_number": 4,
      "step_name": "configuracion_tienda",
      "step_title": "Detalles de la Tienda",
      "status": "pending",
      "is_required": true,
      "can_be_skipped": false
    },
    {
      "step_number": 5,
      "step_name": "completar",
      "step_title": "Finalizar",
      "status": "pending",
      "is_required": true,
      "can_be_skipped": false
    }
  ]
}
```

---

## ‚úÖ Resumen del Servicio

El **Onboarding Service** maneja √∫nicamente los **5 pasos iniciales** del proceso de registro:

1. **üè† Bienvenida** - Landing page est√°tica
2. **üë§ Registro** - Crear tenant/usuario (IAM + Notification)
3. **‚úâÔ∏è Verificaci√≥n** - Validar email (IAM)
4. **üè™ Configuraci√≥n b√°sica** - Tipo de negocio y tama√±o (PIM)
5. **üéâ Completar** - Redirecci√≥n al backoffice

### üéØ Ventajas de la Nueva Estructura:
- ‚úÖ **Steps configurables** via base de datos
- ‚úÖ **Control granular** de estado por paso
- ‚úÖ **Flexibilidad** para agregar/quitar pasos sin c√≥digo
- ‚úÖ **Tracking detallado** de tiempo y errores
- ‚úÖ **Estados claros**: completed, pending, skipped, failed
- ‚úÖ **Datos por paso** almacenados en JSONB
- ‚úÖ **Business types desde PIM** - No duplicamos datos

### üîó Dependencias de Servicios

| **Servicio** | **Puerto** | **Responsabilidad** | **Endpoints Usados** |
|-------------|------------|-------------------|---------------------|
| **IAM Service** | 8080 | Tenants, usuarios, roles, verificaci√≥n | `POST /tenants`, `POST /users`, `GET /roles`, `PUT /tenants/{id}` |
| **PIM Service** | 8090 | Business types, categor√≠as y configuraci√≥n completa | `GET /quickstart/business-types`, `GET /quickstart/categories/{businessType}`, `POST /quickstart/setup` |
| **Notification Service** | TBD | Emails de verificaci√≥n | `POST /notifications/send-email` |
| **Backoffice** | 3000 | Redirecci√≥n post-onboarding | N/A (solo redirect) |

---

## üöÄ Endpoints del Onboarding Service

### **Base URL**: `http://localhost:8110/api/v1/onboarding`

#### üìã **1. Obtener configuraci√≥n de steps**
```http
GET /api/v1/onboarding/steps
```
**Descripci√≥n**: Obtiene la lista de pasos configurados en el onboarding  
**Response**:
```json
{
  "steps": [
    {
      "step_number": 1,
      "step_name": "bienvenida", 
      "step_title": "Bienvenida",
      "description": "Pantalla de bienvenida al onboarding",
      "is_required": true,
      "has_ui": true,
      "requires_user_input": false,
      "can_be_skipped": false
    },
    {
      "step_number": 2,
      "step_name": "registro",
      "step_title": "Datos de Usuario", 
      "description": "Captura nombre, email y contrase√±a",
      "is_required": true,
      "has_ui": true,
      "requires_user_input": true,
      "can_be_skipped": false
    }
  ]
}
```

#### üöÄ **2. Iniciar proceso de onboarding**
```http
POST /api/v1/onboarding/start
```
**Request**:
```json
{
  "source": "landing_page",
  "utm_campaign": "google_ads_q1_2024",
  "referrer": "https://google.com"
}
```
**Response**:
```json
{
  "process_id": "uuid-process-123",
  "current_step": 1,
  "steps_completed": [],
  "steps_pending": [1, 2, 3, 4, 5],
  "next_step_url": "/onboarding/bienvenida"
}
```

#### üë§ **3. Registro de usuario (Paso 2)**
```http
POST /api/v1/onboarding/register-user
```
**Request**:
```json
{
  "process_id": "uuid-process-123",
  "name": "Juan P√©rez",
  "email": "juan@example.com",
  "password": "mi-password-123",
  "password_confirmation": "mi-password-123"
}
```

**‚öôÔ∏è Flujo interno completo:**
1. **üè¢ Crear Tenant autom√°ticamente** con datos temporales
2. **üë§ Obtener rol TENANT_ADMIN** desde IAM Service
3. **üßë‚Äçüíº Crear Usuario** con rol de administrador
4. **üîÑ Actualizar owner** del tenant con el usuario creado
5. **üìß Enviar c√≥digo** de verificaci√≥n

**Response**:
```json
{
  "process_id": "uuid-process-123",
  "user_id": "uuid-user-456",
  "tenant_id": "uuid-tenant-789",
  "tenant_slug": "juan-perez-store",
  "role_assigned": "TENANT_ADMIN",
  "tenant_type": "STARTUP",
  "verification_code_sent": true,
  "can_access_backoffice": true,
  "current_step": 3,
  "steps_completed": [1, 2],
  "steps_pending": [3, 4, 5],
  "next_step_url": "/onboarding/verificar-email"
}
```

#### ‚úâÔ∏è **4. Verificar email (Paso 3)**
```http
POST /api/v1/onboarding/verify-email
```
**Request**:
```json
{
  "process_id": "uuid-process-123",
  "verification_code": "123456"
}
```
**Response**:
```json
{
  "process_id": "uuid-process-123",
  "verified": true,
  "current_step": 4,
  "steps_completed": [1, 2, 3],
  "steps_pending": [4, 5],
  "next_step_url": "/onboarding/configurar-tienda"
}
```

#### üè™ **5. Configurar tienda (Paso 4)**
```http
POST /api/v1/onboarding/setup-store
```
**Request**:
```json
{
  "process_id": "uuid-process-123",
  "store_name": "Pinturer√≠a San Mart√≠n",
  "business_type": "home-construction",
  "store_size": "micro",
  "selected_categories": ["paint", "brushes", "tools"],
  "include_sample_products": true,
  "include_default_attributes": true
}
```

**‚öôÔ∏è Flujo interno:**
1. **üè¢ Actualizar Tenant** con datos finales de la tienda
2. **üìä Determinar plan** recomendado seg√∫n store_size
3. **üéØ Aplicar configuraci√≥n PIM** con categor√≠as y atributos seleccionados
4. **üì¶ Configurar cat√°logo inicial** con productos ejemplo (opcional)
5. **‚úÖ Validar** que el usuario tenga permisos correctos

**Response**:
```json
{
  "process_id": "uuid-process-123",
  "store_configured": true,
  "business_type_applied": "home-construction",
  "store_size_applied": "micro",
  "plan_recommended": "basic",
  "tenant_updated": true,
  "tenant_name": "Pinturer√≠a San Mart√≠n",
  "tenant_slug": "pintureria-san-martin",
  "tenant_type": "STARTUP",
  "catalog_configured": true,
  "categories_created": ["paint", "brushes", "tools"],
  "attributes_created": 15,
  "sample_products_created": 8,
  "pim_setup_completed": true,
  "current_step": 5,
  "steps_completed": [1, 2, 3, 4],
  "steps_pending": [5],
  "next_step_url": "/onboarding/completar"
}
```

**Mapeo completo de `store_size`**:

| store_size | Tenant Type (IAM) | Plan Recomendado | Configuraci√≥n PIM | L√≠mites |
|------------|------------------|------------------|-------------------|---------|
| `micro` | `STARTUP` | `basic` | Template b√°sico | 100 productos, 5 categor√≠as |
| `pyme` | `BUSINESS` | `professional` | Template est√°ndar | 1000 productos, 20 categor√≠as |
| `multiple` | `ENTERPRISE` | `enterprise` | Template completo | Ilimitado, funciones avanzadas |

**Integraci√≥n con otros servicios**:
- **IAM Service**: Actualiza tenant final + asigna plan recomendado
- **PIM Service**: Aplica configuraci√≥n completa de quickstart template
- **Notification Service**: Notifica configuraci√≥n completada

**Datos enviados al PIM Service**:
```json
{
  "businessType": "home-construction",
  "selectedCategories": ["paint", "brushes", "tools"],
  "selectedAttributes": [], // Se incluyen atributos por defecto del business_type
  "selectedVariants": [],   // Se incluyen variantes por defecto del business_type
  "selectedProducts": []    // Se incluyen productos ejemplo si include_sample_products=true
}
```

#### üéâ **6. Completar onboarding (Paso 5)**
```http
POST /api/v1/onboarding/complete
```
**Request**:
```json
{
  "process_id": "uuid-process-123"
}
```

**‚öôÔ∏è Flujo interno final:**
1. **‚úÖ Validar completaci√≥n** de todos los pasos cr√≠ticos
2. **üîê Generar tokens** de acceso para backoffice
3. **üéØ Preparar datos** de configuraci√≥n para backoffice
4. **üè¢ Confirmar permisos** TENANT_ADMIN activos
5. **üìß Notificar** configuraci√≥n lista

**Response**:
```json
{
  "process_id": "uuid-process-123",
  "onboarding_completed": true,
  "completion_time_seconds": 245,
  "user_ready_for_backoffice": true,
  "tenant_admin_confirmed": true,
  "access_token": "jwt-token-for-backoffice",
  "backoffice_url": "/backoffice/dashboard?first_time=true&process_id=uuid-process-123",
  "redirect_url": "https://app.example.com/backoffice/dashboard?first_time=true&process_id=uuid-process-123",
  "tenant_summary": {
    "tenant_id": "uuid-tenant-789",
    "tenant_name": "Pinturer√≠a San Mart√≠n",
    "tenant_slug": "pintureria-san-martin",
    "business_type": "pintureria",
    "store_size": "micro",
    "plan_recommended": "basic",
    "owner_confirmed": true
  },
  "steps_completed": [1, 2, 3, 4, 5],
  "steps_pending": [],
  "total_time_minutes": 4.08
}
```

#### üìä **7. Obtener estado del proceso**
```http
GET /api/v1/onboarding/status/{process_id}
```
**Response**:
```json
{
  "process_id": "uuid-process-123",
  "tenant_id": "uuid-tenant-789", 
  "user_id": "uuid-user-456",
  "current_step": 3,
  "steps_completed": [1, 2],
  "steps_pending": [3, 4, 5],
  "steps_skipped": [],
  "progress_percent": 40.0,
  "is_completed": false,
  "started_at": "2024-01-15T10:30:00Z",
  "estimated_remaining_time_minutes": 3,
  "step_details": [
    {
      "step_number": 1,
      "step_name": "bienvenida",
      "step_title": "Bienvenida",
      "status": "completed",
      "completed_at": "2024-01-15T10:30:30Z",
      "time_spent_seconds": 30
    },
    {
      "step_number": 2,
      "step_name": "registro", 
      "step_title": "Datos de Usuario",
      "status": "completed",
      "completed_at": "2024-01-15T10:32:45Z",
      "time_spent_seconds": 135
    },
    {
      "step_number": 3,
      "step_name": "verificacion",
      "step_title": "Verificar Email",
      "status": "in_progress",
      "started_at": "2024-01-15T10:32:45Z"
    }
  ]
}
```

#### üîÑ **8. Reenviar c√≥digo de verificaci√≥n**
```http
POST /api/v1/onboarding/resend-verification
```
**Request**:
```json
{
  "process_id": "uuid-process-123"
}
```
**Response**:
```json
{
  "verification_code_sent": true,
  "can_resend_again_in_seconds": 60
}
```

#### üè∑Ô∏è **9. Obtener business types disponibles**
```http
GET /api/v1/onboarding/business-types
```
**Descripci√≥n**: Proxy al PIM Service para obtener tipos de negocio actualizados
**Response**:
```json
{
  "business_types": [
    {
      "id": "pintureria",
      "name": "Pinturer√≠a", 
      "description": "Venta de pinturas y accesorios",
      "icon": "üé®"
    },
    {
      "id": "ferreteria",
      "name": "Ferreter√≠a",
      "description": "Herramientas y materiales de construcci√≥n", 
      "icon": "üîß"
    }
  ]
}
```

#### ‚ùå **10. Abandonar proceso**
```http
POST /api/v1/onboarding/abandon
```
**Request**:
```json
{
  "process_id": "uuid-process-123",
  "reason": "too_complicated",
  "feedback": "Demasiados pasos, prefiero hacerlo despu√©s"
}
```
**Response**:
```json
{
  "process_abandoned": true,
  "can_resume": true,
  "resume_url": "/onboarding/resume/uuid-process-123"
}
```

#### üîÑ **11. Reanudar proceso abandonado**
```http
POST /api/v1/onboarding/resume/{process_id}
```
**Response**:
```json
{
  "process_resumed": true,
  "current_step": 3,
  "next_step_url": "/onboarding/verificar-email"
}
```

### üîç **C√≥digos de Error Comunes**

| **C√≥digo** | **Mensaje** | **Descripci√≥n** |
|------------|-------------|-----------------|
| `400` | `INVALID_PROCESS_ID` | Process ID inv√°lido o no encontrado |
| `400` | `STEP_ALREADY_COMPLETED` | Intento de completar un paso ya terminado |
| `400` | `INVALID_VERIFICATION_CODE` | C√≥digo de verificaci√≥n incorrecto |
| `400` | `EMAIL_ALREADY_EXISTS` | Email ya registrado en el sistema |
| `429` | `VERIFICATION_CODE_RATE_LIMIT` | Demasiados intentos de reenv√≠o |
| `500` | `IAM_SERVICE_ERROR` | Error en comunicaci√≥n con IAM Service |
| `500` | `PIM_SERVICE_ERROR` | Error en comunicaci√≥n con PIM Service |
| `500` | `TENANT_CREATION_FAILED` | Error al crear tenant en IAM Service |
| `500` | `USER_CREATION_FAILED` | Error al crear usuario con rol TENANT_ADMIN |
| `400` | `INVALID_ROLE_ASSIGNMENT` | Error al asignar rol TENANT_ADMIN |
| `500` | `TENANT_UPDATE_FAILED` | Error al actualizar datos del tenant |

## üîó **Integraci√≥n Mejorada con PIM Service**

### **üìã Nuevos Endpoints Requeridos en Onboarding:**

#### **1. Obtener Business Types din√°micamente**
```http
GET /api/v1/onboarding/business-types
```
**Descripci√≥n**: Proxy al PIM Service para obtener tipos de negocio actualizados
**Integraci√≥n**: `GET /api/v1/quickstart/business-types` ‚Üí PIM Service

#### **2. Obtener Categor√≠as por Business Type**
```http
GET /api/v1/onboarding/categories?business_type=home-construction
```
**Descripci√≥n**: Proxy al PIM Service para obtener categor√≠as disponibles
**Integraci√≥n**: `GET /api/v1/quickstart/categories/{businessType}` ‚Üí PIM Service

#### **3. Setup Store actualizado con configuraci√≥n PIM**
```http
POST /api/v1/onboarding/setup-store
```
**Nuevo Request**:
```json
{
  "process_id": "uuid-process-123",
  "store_name": "Pinturer√≠a San Mart√≠n",
  "business_type": "home-construction",
  "store_size": "micro",
  "selected_categories": ["paint", "brushes", "tools"],
  "include_sample_products": true,
  "include_default_attributes": true
}
```

### **üéØ Flujo de Integraci√≥n PIM Completo:**

```go
// SetupStoreUseCase - Integraci√≥n completa con PIM Service
func (uc *SetupStoreUseCase) Execute(req SetupStoreRequest) (*SetupStoreResponse, error) {
    // 1. Validar business_type con PIM Service
    businessTypes, err := uc.pimClient.GetBusinessTypes()
    if err != nil {
        return nil, fmt.Errorf("error validating business type: %w", err)
    }
    
    if !isValidBusinessType(req.BusinessType, businessTypes) {
        return nil, fmt.Errorf("invalid business type: %s", req.BusinessType)
    }
    
    // 2. Validar categor√≠as seleccionadas
    availableCategories, err := uc.pimClient.GetCategoriesByBusinessType(req.BusinessType)
    if err != nil {
        return nil, fmt.Errorf("error getting categories: %w", err)
    }
    
    if !areValidCategories(req.SelectedCategories, availableCategories) {
        return nil, fmt.Errorf("invalid categories selected")
    }
    
    // 3. Actualizar tenant en IAM Service
    tenant, err := uc.updateTenant(process.TenantID, req)
    if err != nil {
        return nil, fmt.Errorf("error updating tenant: %w", err)
    }
    
    // 4. Aplicar configuraci√≥n completa en PIM Service
    pimSetupData := &PIMSetupRequest{
        BusinessType:       req.BusinessType,
        SelectedCategories: req.SelectedCategories,
        SelectedAttributes: []string{}, // Usar defaults del business_type
        SelectedVariants:   []string{}, // Usar defaults del business_type
        SelectedProducts:   []string{}, // Opcional seg√∫n req.IncludeSampleProducts
    }
    
    // 4.1. Incluir productos ejemplo si se solicita
    if req.IncludeSampleProducts {
        sampleProducts, err := uc.pimClient.GetSampleProductsByBusinessType(req.BusinessType)
        if err == nil && len(sampleProducts) > 0 {
            // Limitar a m√°ximo 5 productos ejemplo para onboarding r√°pido
            if len(sampleProducts) > 5 {
                pimSetupData.SelectedProducts = sampleProducts[:5]
            } else {
                pimSetupData.SelectedProducts = sampleProducts
            }
        }
    }
    
    // 4.2. Aplicar configuraci√≥n PIM
    pimHistory, err := uc.pimClient.SetupTenant(process.TenantID, pimSetupData)
    if err != nil {
        return nil, fmt.Errorf("error configuring PIM: %w", err)
    }
    
    // 5. Actualizar proceso con configuraci√≥n completada
    process.PIMConfigured = true
    process.CatalogSetupCompleted = true
    process.CategoriesConfigured = len(req.SelectedCategories)
    process.AttributesConfigured = len(pimHistory.AttributesCreated)
    process.ProductsConfigured = len(pimHistory.ProductsCreated)
    
    return &SetupStoreResponse{
        // ... campos existentes ...
        CatalogConfigured:      true,
        CategoriesCreated:      req.SelectedCategories,
        AttributesCreated:      len(pimHistory.AttributesCreated),
        SampleProductsCreated:  len(pimHistory.ProductsCreated),
        PIMSetupCompleted:      true,
    }, nil
}
```

### **üìä Mapeo de Business Types:**

```go
// Mapeo entre UI amigable y business_type del PIM
var BusinessTypeMapping = map[string]string{
    "pintureria":      "home-construction",
    "ferreteria":      "home-construction",
    "ropa":            "fashion",
    "electronica":     "electronics",
    "automotriz":      "automotive",
    "libros":          "books-media",
    "alimentos":       "food-beverage",
    "farmacia":        "health-pharmacy",
    "deportes":        "sports-fitness",
    "belleza":         "beauty-cosmetics",
    "juguetes":        "toys-games",
    "mascotas":        "pet-supplies",
    "oficina":         "office-supplies",
    "joyeria":         "jewelry-accessories",
    "polirubro":       "polirubro",
}

func mapToBusinessType(userFriendlyType string) string {
    if pimType, exists := BusinessTypeMapping[userFriendlyType]; exists {
        return pimType
    }
    return userFriendlyType // fallback
}
```

### **üîÑ Endpoints PIM Service utilizados:**

| Endpoint PIM | Prop√≥sito | Cu√°ndo se usa |
|-------------|-----------|---------------|
| `GET /quickstart/business-types` | Obtener lista de tipos de negocio | Al cargar paso 4 (dropdown) |
| `GET /quickstart/categories/{businessType}` | Obtener categor√≠as disponibles | Al seleccionar business_type |
| `POST /quickstart/setup` | Aplicar configuraci√≥n completa | Al confirmar setup en paso 4 |

### **‚úÖ Validaciones agregadas:**

1. **Business Type v√°lido**: Verificar contra lista del PIM Service
2. **Categor√≠as v√°lidas**: Verificar que las categor√≠as seleccionadas existen para el business_type
3. **M√≠nimo una categor√≠a**: El usuario debe seleccionar al menos 1 categor√≠a
4. **Productos ejemplo limitados**: M√°ximo 5 productos ejemplo para onboarding r√°pido

### **üéØ Resultado Final Garantizado:**

Despu√©s del paso 4, el tenant tendr√°:
- ‚úÖ **Configuraci√≥n IAM**: Tenant actualizado con datos finales
- ‚úÖ **Configuraci√≥n PIM**: Cat√°logo b√°sico con categor√≠as y atributos
- ‚úÖ **Productos ejemplo**: Hasta 5 productos ejemplo (opcional)
- ‚úÖ **Estructura base**: Lista para comenzar a usar en backoffice

## üîí **Validaciones y Requisitos para Backoffice**

### **‚úÖ Requisitos obligatorios para acceso al backoffice:**

#### **1. Usuario TENANT_ADMIN activo**
```go
// Validaciones que debe pasar el usuario:
type BackofficeAccessValidation struct {
    UserID     string `validate:"required,uuid"`
    TenantID   string `validate:"required,uuid"`
    RoleType   string `validate:"required,eq=TENANT_ADMIN"`
    UserStatus string `validate:"required,eq=ACTIVE"`
    EmailVerified bool `validate:"required,eq=true"`
}
```

#### **2. Tenant configurado correctamente**
```go
// Validaciones del tenant:
type TenantValidation struct {
    TenantID    string `validate:"required,uuid"`
    TenantName  string `validate:"required,min=2,max=100"`
    TenantSlug  string `validate:"required,min=2,max=50"`
    TenantType  string `validate:"required,oneof=STARTUP BUSINESS ENTERPRISE"`
    OwnerID     string `validate:"required,uuid"`
    TenantStatus string `validate:"required,eq=ACTIVE"`
}
```

#### **3. Proceso de onboarding completado**
```go
// Validaciones del proceso:
type OnboardingValidation struct {
    ProcessID      string `validate:"required,uuid"`
    IsCompleted    bool   `validate:"required,eq=true"`
    StepsCompleted []int  `validate:"required,len=5"`
    EmailVerified  bool   `validate:"required,eq=true"`
}
```

### **üîê Permisos m√≠nimos requeridos:**

El usuario debe tener rol **TENANT_ADMIN** con los siguientes permisos:
- `tenant:*` - Gesti√≥n completa del tenant
- `user:*` - Gesti√≥n de usuarios del tenant  
- `role:*` - Gesti√≥n de roles del tenant

### **üö® Validaciones de seguridad:**

#### **1. Verificaci√≥n de ownership**
```go
func (uc *ValidateBackofficeAccessUseCase) ValidateOwnership(userID, tenantID string) error {
    tenant, err := uc.iamClient.GetTenantByID(tenantID)
    if err != nil {
        return fmt.Errorf("tenant not found: %w", err)
    }
    
    if tenant.OwnerID != userID {
        return fmt.Errorf("user is not the owner of the tenant")
    }
    
    return nil
}
```

#### **2. Verificaci√≥n de rol activo**
```go
func (uc *ValidateBackofficeAccessUseCase) ValidateRole(userID string) error {
    user, err := uc.iamClient.GetUserByID(userID)
    if err != nil {
        return fmt.Errorf("user not found: %w", err)
    }
    
    role, err := uc.iamClient.GetRoleByID(user.RoleID)
    if err != nil {
        return fmt.Errorf("role not found: %w", err)
    }
    
    if role.Type != "TENANT_ADMIN" {
        return fmt.Errorf("user does not have TENANT_ADMIN role")
    }
    
    if !role.IsActive {
        return fmt.Errorf("role is not active")
    }
    
    return nil
}
```

### **üìä Flujo de validaci√≥n completo antes del backoffice:**

```go
func (uc *CompleteOnboardingUseCase) ValidateBackofficeReadiness(processID string) (*BackofficeReadinessResponse, error) {
    // 1. Validar proceso completo
    process, err := uc.onboardingRepo.GetByID(processID)
    if err != nil {
        return nil, fmt.Errorf("process not found: %w", err)
    }
    
    if !process.IsCompleted || len(process.StepsCompleted) < 5 {
        return nil, fmt.Errorf("onboarding process not completed")
    }
    
    // 2. Validar usuario y rol
    user, err := uc.iamClient.GetUserByID(process.UserID)
    if err != nil {
        return nil, fmt.Errorf("user validation failed: %w", err)
    }
    
    // Verificar que tiene rol TENANT_ADMIN
    role, err := uc.iamClient.GetRoleByID(user.RoleID)
    if err != nil || role.Type != "TENANT_ADMIN" {
        return nil, fmt.Errorf("user does not have required TENANT_ADMIN role")
    }
    
    // 3. Validar tenant
    tenant, err := uc.iamClient.GetTenantByID(process.TenantID)
    if err != nil {
        return nil, fmt.Errorf("tenant validation failed: %w", err)
    }
    
    if tenant.Status != "ACTIVE" || tenant.OwnerID != user.ID {
        return nil, fmt.Errorf("tenant validation failed: inactive or ownership mismatch")
    }
    
    // 4. Validar email verificado
    if !user.EmailVerified {
        return nil, fmt.Errorf("email not verified")
    }
    
    return &BackofficeReadinessResponse{
        Ready: true,
        UserID: user.ID,
        TenantID: tenant.ID,
        RoleType: role.Type,
        Permissions: role.Permissions,
        CanAccessBackoffice: true,
        ValidationsPassed: []string{
            "onboarding_completed",
            "user_active",
            "role_tenant_admin",
            "tenant_active",
            "ownership_confirmed",
            "email_verified",
        },
    }, nil
}
```

**Puerto**: 8110 | **Base de datos**: onboarding_db | **Arquitectura**: Hexagonal 